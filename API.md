# API Documentation

## Custom Hooks

### useLocalStorageSSR

**Purpose**: SSR-safe localStorage hook that prevents hydration mismatches.

```typescript
function useLocalStorageSSR<T>(
  key: string,
  initialValue: T
): [T, (value: T | ((prev: T) => T)) => void, boolean];
```

**Parameters:**

- `key: string` - The localStorage key to use
- `initialValue: T` - The initial value to use if no stored value exists

**Returns:**

- `[0]: T` - The current stored value
- `[1]: (value: T | ((prev: T) => T)) => void` - Function to update the stored value
- `[2]: boolean` - Loading state indicating if the value has been loaded from localStorage

**Example:**

```typescript
const [user, setUser, isLoaded] = useLocalStorageSSR<User | null>(
  'currentUser',
  null
);

if (!isLoaded) {
  return <LoadingSpinner />;
}

// Safe to use user value here
```

**Features:**

- ✅ Prevents hydration mismatch errors
- ✅ Type-safe with TypeScript generics
- ✅ Stable dependencies to prevent infinite loops
- ✅ Automatic serialization/deserialization
- ✅ Error handling for localStorage issues

---

### useUserStorage

**Purpose**: User management with data isolation and session handling.

```typescript
function useUserStorage(): {
  currentUser: User | null;
  createUser: (name: string) => User;
  deleteUser: (userId: string) => void;
  logoutUser: () => void;
  getUserStorageKey: (baseKey: string) => string;
  isCurrentUserLoaded: boolean;
};
```

**Returns:**

#### `currentUser: User | null`

The currently active user, or null if no user is logged in.

#### `createUser: (name: string) => User`

Creates a new user and sets them as the current active user.

**Parameters:**

- `name: string` - The name for the new user

**Returns:**

- `User` - The newly created user object

**Behavior:**

- Clears any existing user data (One Device, One User model)
- Generates a unique user ID
- Sets the new user as current
- Returns the created user

#### `deleteUser: (userId: string) => void`

Deletes a user and all their associated data.

**Parameters:**

- `userId: string` - The ID of the user to delete

**Behavior:**

- Clears all user-specific data from localStorage
- If deleting the current user, logs them out
- In One Device, One User model, this typically means clearing all data

#### `logoutUser: () => void`

Logs out the current user without deleting their data.

**Behavior:**

- Sets currentUser to null
- Returns to user selection/creation screen
- Preserves user data in localStorage

#### `getUserStorageKey: (baseKey: string) => string`

Generates a user-specific storage key for data isolation.

**Parameters:**

- `baseKey: string` - The base storage key

**Returns:**

- `string` - User-specific storage key (e.g., "transactions_user123")

**Example:**

```typescript
const transactionKey = getUserStorageKey('transactions');
// Returns: "transactions_user_1234567890" (if user is logged in)
// Returns: "transactions" (if no user is logged in)
```

#### `isCurrentUserLoaded: boolean`

Loading state indicating if the current user data has been loaded.

**Usage:**

```typescript
const { currentUser, isCurrentUserLoaded } = useUserStorage();

if (!isCurrentUserLoaded) {
  return <LoadingSpinner />;
}

if (!currentUser) {
  return <WelcomeScreen />;
}

return <Dashboard />;
```

---

## Types

### User

```typescript
interface User {
  id: string; // Unique identifier generated by the system
  name: string; // User-provided name
  createdAt: string; // ISO string of creation date
}
```

### Transaction

```typescript
interface Transaction {
  id: string;
  description: string;
  amount: number;
  type: 'income' | 'expense';
  category: string;
  date: string; // ISO string
  tags?: string[];
  isRecurring?: boolean;
  recurringFrequency?: 'weekly' | 'monthly' | 'yearly';
}
```

---

## Storage Keys

The application uses these base storage keys:

```typescript
const storageKeys = {
  TRANSACTIONS: 'cashflow_transactions',
  BUDGETS: 'cashflow_budgets',
  FINANCIAL_GOALS: 'cashflow_financial_goals',
  CURRENT_USER: 'currentUser',
  USERS: 'users', // Not used in One Device, One User model
};
```

**User-Specific Keys:**
When a user is logged in, data is stored with user-specific keys:

- `cashflow_transactions_user_1234567890`
- `cashflow_budgets_user_1234567890`
- `cashflow_financial_goals_user_1234567890`

---

## Error Handling

### localStorage Errors

All localStorage operations are wrapped in try-catch blocks:

```typescript
try {
  const item = window.localStorage.getItem(key);
  if (item) {
    return JSON.parse(item);
  }
} catch (error) {
  console.error(`Error loading localStorage key "${key}":`, error);
  // Return default value
}
```

### Hydration Errors

The SSR-safe hooks prevent hydration errors by:

1. Starting with default values on both server and client
2. Loading actual values only after client-side hydration
3. Using loading states to prevent premature rendering
4. Stable dependencies to prevent re-render loops

---

## Best Practices

### Using useLocalStorageSSR

```typescript
// ✅ Good: Always check loading state
const [data, setData, isLoaded] = useLocalStorageSSR('key', defaultValue);

if (!isLoaded) {
  return <LoadingSpinner />;
}

// Now safe to use data

// ✅ Good: Use functional updates for complex state
setData((prevData) => ({ ...prevData, newField: value }));
```

### Using useUserStorage

```typescript
// ✅ Good: Check both loading and user state
const { currentUser, isCurrentUserLoaded } = useUserStorage();

if (!isCurrentUserLoaded) {
  return <LoadingSpinner />;
}

if (!currentUser) {
  return <UserManagement />;
}

// ✅ Good: Use getUserStorageKey for user-specific data
const storageKey = getUserStorageKey('myData');
const [myData, setMyData] = useLocalStorageSSR(storageKey, defaultValue);
```

### Error Boundaries

Wrap components that use these hooks in error boundaries:

```typescript
<ErrorBoundary fallback={<ErrorFallback />}>
  <ComponentUsingHooks />
</ErrorBoundary>
```
